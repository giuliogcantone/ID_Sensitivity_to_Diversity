---
title: "Sampling from OA"
author: "GG Cantone"
date: "2023-06-02"
output:
---

In case you have not the package manager `pacman`, install it.

```{r}
install.packages(pacman)
```

Setup

```{r setup, include=FALSE}
pacman::p_load(
  tidyverse,
  openalexR,
  readr,
  janitor,
  ggExtra
)
```

---

Sampling all concepts

```{r}
oa_fetch(
  entity = "concepts",
  level = c(0:1)
) -> concepts
```

---

Importing WOS

```{r}
read_csv("Scientific.csv") %>%
  add_row(read_csv("Social_Sciences.csv")) %>%
  select(-`Publisher address`) %>%
  distinct(`Journal title`,
           .keep_all = T) %>%
  pivot_longer(cols = c("ISSN","eISSN"),
               names_to = "Type",
               values_to = "ISSN"
  ) %>%
  select(-Type) %>%
  distinct(`Journal title`,
           .keep_all = T) -> WoS_j
```

Download OpenAlex data on journals

```{r}
oa_fetch(
  entity = "venues",
  issn = WoS_j$ISSN
) -> journals
```

Joins of categories

```{r}
journals %>%
  transmute(id_j = id,
         journal = display_name,
         main_issn = issn_l %>% as.character(),
         n_papers = works_count,
         x_concepts) %>%
  left_join(WoS_j %>%
              rename(WoS_JSC = `Web of Science Categories`,
                     main_issn = ISSN
                     ) %>%
              select(main_issn,WoS_JSC,
                     Languages)) %>%
  filter(!WoS_JSC %>% is.na(),
         !x_concepts %>% is.na()) -> db_j
```

Data cleaning

```{r}
db_j %>%
  mutate(refined_WoS_JSC = WoS_JSC %>%
           str_replace("Public, Environmental & Occupational Health",
                       "Public Health") %>%
           str_replace_all(",",":") %>%
           str_replace_all(" \\| ",", "),
         coarse_WoS_JSC = refined_WoS_JSC %>%
           str_remove_all("\\:.*?(?=,|$)"),
         coarse_WoS_JSC =
           map_chr(str_split(coarse_WoS_JSC,", "),
                   ~ str_c(unique(.x), collapse = ", ")),
         mention_multidis = str_detect(tolower(WoS_JSC),"multidis|interdis"),
         n_coarse = str_count(coarse_WoS_JSC,","),
         multidis = if_else((n_coarse == 0) &
                              (mention_multidis == 0),
                            0,1)
         ) %>%
  mutate(x_concepts = map(x_concepts, ~ filter(.x,level < 2))
         ) -> db_j

```

How many combinations of WOS categories?

```{r}

db_j %>%
  count(coarse_WoS_JSC) %>% View()

db_j %>%
  count(refined_WoS_JSC) %>% View()

```


Map mono-disciplinary association

```{r}

db_j %>%
  filter(multidis == 0) %>%
  unnest(x_concepts) %>%
  summarise(score = sum(score*n_papers),
            .by = c(coarse_WoS_JSC,display_name)
            ) %>%
  rename(OpAl_JSC = display_name) %>%
  arrange(coarse_WoS_JSC,-score) %>%
  mutate(score = score/sum(score),
         .by = coarse_WoS_JSC) %>%
  adorn_rounding(4) %>%
  View()

```

Berger correlation

```{r}

db_j %>%
  filter(multidis == 0) %>%
  unnest(x_concepts) %>%
  summarise(score = sum(score*n_papers),
            .by = c(coarse_WoS_JSC,display_name)
            ) %>%
  rename(OpAl_JSC = display_name) %>%
  arrange(coarse_WoS_JSC,-score) %>%
  mutate(score = score/sum(score),
         .by = coarse_WoS_JSC) %>%
  adorn_rounding(4) %>%
  filter(score == max(score),
         .by = coarse_WoS_JSC) %>%
  mutate(name_lgt = str_length(coarse_WoS_JSC)) -> berger_map

```


Marginal Scatterplot

```{r}
berger_map %>%
  ggplot(aes(x = score,
             y = name_lgt)) +
  geom_point() -> p
  ggMarginal(p)
```



## 

Sample papers

```{r}
oa_fetch(
  entity = "works",
  abstract = F,
  publication_year = c(2011:2015),
  type = "journal-article",
  options = list(sample = 10)
) -> sample
```
